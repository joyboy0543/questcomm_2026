<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Treasure Hunt</title>
  <style>
    :root {
      --bg: #0f1223;
      --panel: #171a2e;
      --accent: #6ee7b7;
      --accent2: #93c5fd;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #fca5a5;
      --success: #86efac;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "ComicShanns Mono", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #121533, #0c0f1f);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 2rem;
    }

    .card {
      width: 100%;
      max-width: 720px;
      background: var(--panel);
      border: 1px solid #22264a;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      overflow: hidden;
    }

    header {
      padding: 1.1rem 1.5rem;
      background: linear-gradient(90deg, #1b1e38, #20244a);
      border-bottom: 1px solid #2a2e56;
    }

    header h1 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: 0.3px;
    }

    main {
      padding: 1.5rem;
    }

    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .field {
      flex: 1 1 240px;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    label {
      font-size: 0.9rem;
      color: var(--muted);
    }

    input[type="text"] {
      padding: 0.75rem 0.9rem;
      border-radius: 10px;
      border: 1px solid #30365f;
      background: #11132a;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus {
      border-color: var(--accent2);
    }

    button {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #0b1024;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.05s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .hint {
      color: var(--accent2);
      font-size: 0.95rem;
      margin-top: 0.25rem;
    }

    .error {
      color: var(--danger);
    }

    .ok {
      color: var(--success);
    }

    .divider {
      margin: 1rem 0 1.25rem;
      border-top: 1px dashed #2a2e56;
    }

    .puzzle {
      background: #121534;
      border: 1px solid #2a2e56;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .puzzle h2 {
      margin: 0 0 0.25rem 0;
      font-size: 1.1rem;
    }

    .puzzle-number {
      color: var(--accent);
      font-weight: 700;
    }

    .foot {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .hidden {
      display: none;
    }

    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 8px;
      background: #0d1026;
      border: 1px solid #2a2e56;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .success-box {
      background: #0d2518;
      border: 1px solid #1e6b4a;
      padding: 0.75rem;
      border-radius: 10px;
      color: #a7f3d0;
    }

    .link {
      color: var(--accent2);
      text-decoration: underline;
      cursor: pointer;
    }

    /* --- Reset modal styles --- */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(9, 11, 25, 0.75);
      backdrop-filter: blur(2px);
      display: grid;
      place-items: center;
      z-index: 9999;
    }

    .modal-card {
      width: 100%;
      max-width: 560px;
      background: #11152f;
      border: 1px solid #2a2e56;
      border-radius: 14px;
      padding: 1rem 1.25rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    .modal h2 {
      margin: 0 0 0.5rem 0;
    }

    .modal p {
      margin: 0.25rem 0 0.75rem 0;
      color: var(--muted);
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    button.warn {
      background: linear-gradient(90deg, #fcd34d, #f59e0b);
      color: #0b1024;
    }

    button.danger {
      background: linear-gradient(90deg, #fca5a5, #ef4444);
      color: #0b1024;
    }
  </style>
</head>

<body>
  <div class="card">
    <header>
      <h1>üéØ QR Treasure Hunt</h1>
    </header>
    <main>
      <!-- Onboarding -->
      <section id="onboarding">
        <p class="muted">Scan the QR, enter your details, and start the hunt. Solve each level to unlock the next!</p>
        <div class="row">
          <div class="field">
            <label for="team">Team name (optional)</label>
            <input type="text" id="team" placeholder="e.g., Clue Masters" />
          </div>
          <div class="field">
            <label for="name">Your name</label>
            <input type="text" id="name" placeholder="e.g., Jay" />
          </div>
        </div>
        <div class="foot">
          <span class="badge">Progress is auto-saved.</span>
          <button id="startBtn">Start</button>
        </div>
        <p id="onboardingMsg" class="error hidden"></p>
        <div class="divider"></div>
        <p class="muted">
          Tip: Prefill via QR query params like <code>?team=ClueMasters&name=Jay&qr=posterA</code>.
          &nbsp;|&nbsp; Troubleshooting: <span id="hardReset" class="link">Reset progress</span>
        </p>
      </section>

      <!-- Game -->
      <section id="game" class="hidden">
        <p id="welcome" class="muted"></p>

        <!-- Puzzle 1 -->
        <div id="p1" class="puzzle">
          <h2><span class="puzzle-number">Level 1</span> ‚Äî Riddle</h2>
          <p>What has cities, but no houses; forests, but no trees; and water, but no fish?</p>
          <div class="row">
            <div class="field">
              <label for="ans1">Answer</label>
              <input type="text" id="ans1" placeholder="Type your answer‚Ä¶" />
            </div>
          </div>
          <div class="foot">
            <span class="hint">One word.</span>
            <button id="check1">Check</button>
          </div>
          <p id="msg1" class="muted"></p>
        </div>

        <!-- Puzzle 2 -->
        <div id="p2" class="puzzle hidden">
          <h2><span class="puzzle-number">Level 2</span> ‚Äî Caesar Shift</h2>
          <p><strong>Encoded word:</strong> <code>wuhdvxuh</code></p>
          <ul class="muted">
            <li>Hint: The shift equals the number of corners in a triangle.</li>
            <li>Enter the decoded word (letters only).</li>
          </ul>
          <div class="row">
            <div class="field">
              <label for="ans2">Answer</label>
              <input type="text" id="ans2" placeholder="e.g., treasure" />
            </div>
          </div>
          <div class="foot">
            <span class="hint">Shift by 3 in the alphabet.</span>
            <button id="check2">Check</button>
          </div>
          <p id="msg2" class="muted"></p>
        </div>

        <!-- Puzzle 3 -->
        <div id="p3" class="puzzle hidden">
          <h2><span class="puzzle-number">Level 3</span> ‚Äî 4‚ÄëDigit Logic Code</h2>
          <ul class="muted">
            <li>All four digits are different.</li>
            <li>The <strong>sum</strong> of the digits is <strong>14</strong>.</li>
            <li><strong>1st</strong> = letters in ‚ÄúTEAM‚Äù.</li>
            <li><strong>2nd</strong> = vowels in ‚Äúcommunication‚Äù.</li>
            <li><strong>3rd</strong> = (1st ‚àí 1). <strong>4th</strong> = 1.</li>
          </ul>
          <div class="row">
            <div class="field">
              <label for="ans3">Code</label>
              <input type="text" id="ans3" placeholder="e.g., 4631" />
            </div>
          </div>
          <div class="foot">
            <span class="hint">Digits only. No spaces.</span>
            <button id="check3">Check</button>
          </div>
          <p id="msg3" class="muted"></p>
        </div>

        <!-- Success -->
        <div id="done" class="hidden">
          <div class="success-box">
            <p id="congrats" class="ok"></p>
            <p class="muted">You‚Äôve completed all levels. üéâ</p>
          </div>
          <p class="muted">
            Want to play again or share with friends? Reset your progress:
            <span id="reset" class="link">Reset</span>
          </p>
        </div>
      </section>

      <!-- Reset / Resume modal -->
      <div id="resetModal" class="modal hidden" aria-modal="true" role="dialog">
        <div class="modal-card">
          <h2 id="resetTitle">Resume or reset?</h2>
          <p id="resetDesc">You reloaded during a puzzle. What would you like to do?</p>
          <div class="modal-actions">
            <button id="btnContinue">Continue</button>
            <button id="btnResetCurrent" class="warn">Reset current level</button>
            <button id="btnResetAll" class="danger">Reset all levels</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // ========= CONFIG =========
    // Keep your existing Apps Script Web App URL:
    const LOG_URL = 'https://script.google.com/macros/s/AKfycbz__kDopuMd2AMvVJBKqSTV5B74U-7b6d_LNbj3T78TqeAVLozBd8_Sw29kszkSYkrtQg/exec';

    // ========= SAFE HELPERS =========
    const $ = sel => document.querySelector(sel);
    function on(sel, ev, fn) {
      const el = $(sel);
      if (!el) { console.error('Missing element for selector:', sel); return false; }
      el.addEventListener(ev, fn);
      return true;
    }
    function show(sel) {
      const el = $(sel);
      if (!el) return console.error('show(): missing', sel);
      el.classList.remove('hidden');
    }
    function hide(sel) {
      const el = $(sel);
      if (!el) return console.error('hide(): missing', sel);
      el.classList.add('hidden');
    }

    // ========= UTILITIES =========
    const params = new URLSearchParams(location.search);

    // Navigation type (reload vs. fresh)
    const navEntry = performance.getEntriesByType('navigation')[0];
    const isReload = navEntry?.type === 'reload';
    const forcedReset = params.get('reset') === '1'; // we prompt later if progress exists

    // localStorage helpers
    const saveState = (obj) => {
      const state = JSON.parse(localStorage.getItem('qrHuntState') || '{}');
      const merged = { ...state, ...obj };
      localStorage.setItem('qrHuntState', JSON.stringify(merged));
    };
    const getState = () => JSON.parse(localStorage.getItem('qrHuntState') || '{}');
    const clearState = () => localStorage.removeItem('qrHuntState');

    // Session id
    const getRunId = () => {
      const s = getState();
      if (!s.runId) {
        s.runId = Math.random().toString(36).slice(2) + Date.now().toString(36);
        saveState({ runId: s.runId });
      }
      return s.runId;
    };

    // Which level appears next, based on stored progress
    function getCurrentLevelFromState() {
      const s = getState();
      const lc = (s.levelCompleted ?? -1);
      return Math.min(lc + 1, 4); // 1..4 (4=done screen)
    }

    // Clear UI fields for a given level (without wiping state)
    function clearLevelInputs(level) {
      const msgs = ['#msg1', '#msg2', '#msg3'];
      const inputs = ['#ans1', '#ans2', '#ans3'];
      if (level >= 1 && level <= 3) {
        $(inputs[level - 1]).value = '';
        const m = $(msgs[level - 1]);
        m.textContent = '';
        m.classList.remove('error');
      }
    }

    // ========= LOGGER =========
    async function logEvent(event, extras = {}) {
      try {
        const s = getState();
        const body = {
          name: s.name || '',
          team: s.team || '',
          event,                         // "start" | "level_complete" | "finished" | "reset_current" | "reset_all"
          level: extras.level ?? '',
          success: extras.success ?? '',
          siteUrl: location.href,
          qp: location.search,           // includes ?qr=posterA etc.
          clientTime: new Date().toISOString(),
          clientTZ: Intl.DateTimeFormat().resolvedOptions().timeZone,
          runId: getRunId(),
          ua: navigator.userAgent
        };
        // CORS-safe (Apps Script will still receive the payload)
        await fetch(LOG_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(body),
        });
      } catch (e) {
        console.warn('logEvent failed', e);
      }
    }

    // ========= ONBOARDING =========
    // Prefill from URL query
    (function prefill() {
      const teamQ = params.get('team') || '';
      const nameQ = params.get('name') || '';
      if (teamQ) $('#team').value = teamQ;
      if (nameQ) $('#name').value = nameQ;
    })();

    // Render from storage (resume) with safe refresh modal
    (function initFromStorage() {
      const s = getState();
      const activeLevel = getCurrentLevelFromState();

      if (s.name || s.team) {
        hide('#onboarding'); show('#game');
        $('#welcome').textContent = `Welcome${s.team ? ' Team ' + s.team : ''}${s.name ? ', ' + s.name : ''}!`;

        // If the user reloaded mid-game (not finished) OR visited with ?reset=1, show choices
        if ((isReload || forcedReset) && activeLevel <= 3) {
          $('#resetDesc').textContent = `You reloaded during Level ${activeLevel}. What would you like to do?`;
          show('#resetModal'); // wait for user choice
        } else {
          // Normal resume
          revealLevel(Math.min(activeLevel, 4));
        }
      }
    })();

    // Start button
    on('#startBtn', 'click', () => {
      const name = $('#name').value.trim();
      const team = $('#team').value.trim();
      if (!name && !team) {
        $('#onboardingMsg').textContent = 'Please enter at least a name or a team name.';
        $('#onboardingMsg').classList.remove('hidden');
        return;
      }
      saveState({ name, team, levelCompleted: -1, startedAt: Date.now() });
      logEvent('start', { level: 1, success: true });

      hide('#onboarding'); show('#game');
      $('#welcome').textContent = `Welcome${team ? ' Team ' + team : ''}${name ? ', ' + name : ''}!`;
      revealLevel(1);
    });

    // Manual reset from onboarding
    on('#hardReset', 'click', () => {
      clearState();
      location.reload();
    });

    // ========= GAME LOGIC =========
    function revealLevel(n) {
      hide('#p1'); hide('#p2'); hide('#p3'); hide('#done');
      if (n === 1) show('#p1');
      else if (n === 2) show('#p2');
      else if (n === 3) show('#p3');
      else show('#done');
    }

    // Level 1 (answer: map)
    on('#check1', 'click', () => {
      const val = $('#ans1').value.trim().toLowerCase();
      const ok = ['map'].includes(val);
      const msg = $('#msg1');
      if (ok) {
        msg.textContent = '‚úÖ Correct! Level 2 unlocked.';
        saveState({ levelCompleted: 0, l1At: Date.now() });
        logEvent('level_complete', { level: 1, success: true });
        revealLevel(2);
      } else {
        msg.textContent = '‚ùå Not quite. Think: paper, roads, rivers.';
        msg.classList.add('error');
      }
    });

    // Level 2 (answer: treasure; Caesar shift 3)
    on('#check2', 'click', () => {
      const val = $('#ans2').value.trim().toLowerCase();
      const ok = val === 'treasure';
      const msg = $('#msg2');
      if (ok) {
        msg.textContent = '‚úÖ Nice! Level 3 unlocked.';
        saveState({ levelCompleted: 1, l2At: Date.now() });
        logEvent('level_complete', { level: 2, success: true });
        revealLevel(3);
      } else {
        msg.textContent = '‚ùå Try decoding with a shift of 3.';
        msg.classList.add('error');
      }
    });

    // Level 3 (answer: 4631)
    on('#check3', 'click', () => {
      const val = $('#ans3').value.trim();
      const ok = val === '4631';
      const msg = $('#msg3');
      if (ok) {
        const s = getState();
        msg.textContent = '‚úÖ Correct!';
        saveState({ levelCompleted: 2, completedAt: Date.now() });
        logEvent('finished', { level: 3, success: true });
        const nameOrTeam = s.team ? `Team ${s.team}` : (s.name || 'Player');
        $('#congrats').textContent = `Congrats ${nameOrTeam}! You finished all puzzles. üéâ`;
        revealLevel(4);
      } else {
        msg.textContent = '‚ùå Re-check the clues: letters, vowels, minus one, then 1.';
        msg.classList.add('error');
      }
    });

    // Success reset
    on('#reset', 'click', () => {
      clearState();
      location.reload();
    });

    // ========= RESET MODAL ACTIONS =========
    function bindResetModalHandlers() {
      const ok1 = on('#btnContinue', 'click', () => {
        hide('#resetModal');
        revealLevel(getCurrentLevelFromState());
      });

      const ok2 = on('#btnResetCurrent', 'click', () => {
        const level = getCurrentLevelFromState();
        clearLevelInputs(level);
        hide('#resetModal');
        revealLevel(level);
        logEvent('reset_current', { level, success: false });
      });

      const ok3 = on('#btnResetAll', 'click', () => {
        const level = getCurrentLevelFromState();
        logEvent('reset_all', { level, success: false });
        clearState();
        const url = new URL(location.href);
        url.searchParams.delete('reset');
        location.href = url.toString();
      });

      // Fallback if any button didn‚Äôt bind‚Äîauto-continue so user isn‚Äôt stuck
      if (!ok1 || !ok2 || !ok3) {
        console.warn('Modal handlers not fully bound‚Äîauto-continue fallback');
        hide('#resetModal');
        revealLevel(getCurrentLevelFromState());
      }
    }

    // Bind after DOM is fully ready
    window.addEventListener('load', bindResetModalHandlers);
  </script>
</body>

</html>